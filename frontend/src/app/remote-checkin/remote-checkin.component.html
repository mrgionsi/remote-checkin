<div class="card flex justify-center">
    <p-toast></p-toast>
</div>
<div class="card justify-center" *ngIf="!showConfirmationDialog">
    <p-stepper [value]="1" class="basis-[80rem]">
        <p-step-list>
            <p-step [value]="1">{{ 'client-information' | transloco }}</p-step>
            <p-step [disabled]="clientForm.invalid" [value]="2">{{ 'upload-images-step' | transloco
                }}</p-step>
            <p-step [disabled]="uploadForm.invalid" [value]="3">{{ 'confirm-data-step' | transloco
                }}</p-step>
        </p-step-list>

        <!-- Capacity Status Indicator -->
        <div *ngIf="reservationDetails" class="mb-6 flex justify-center" aria-live="polite">
            <div class="p-6 border-round shadow-2 max-w-md w-full text-center"
                [ngClass]="canRegister ? 'bg-green-50 border-green-300 border-1' : 'bg-red-50 border-red-300 border-1'">
                <div class="flex flex-column align-items-center">
                    <i class="mb-3 text-4xl"
                        [ngClass]="canRegister ? 'pi pi-check-circle text-green-600' : 'pi pi-times-circle text-red-600'"></i>
                    <span class="font-bold text-xl mb-2" [ngClass]="canRegister ? 'text-green-800' : 'text-red-800'">
                        {{ (canRegister ? 'registration-available' : 'registration-full') | transloco }}
                    </span>
                    <div class="text-sm mb-2" [ngClass]="canRegister ? 'text-green-700' : 'text-red-700'">
                        {{ 'capacity-status' | transloco: {registered: registeredClientsCount, max:
                        reservationDetails.number_of_people || 1} }}
                    </div>
                    <div *ngIf="!canRegister" class="text-sm text-red-600 font-medium">
                        {{ 'reservation-full-message' | transloco }}
                    </div>
                </div>
            </div>
        </div>

        <p-step-panels>
            <p-step-panel [value]="1">
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="flex flex-col h-48">
                        <div class="flex-auto justify-center items-center font-medium">
                            <p-card header="{{ 'client-information' | transloco }}">
                                <form [formGroup]="clientForm" class="p-fluid" [class.opacity-50]="!canRegister">
                                    <div class="grid">
                                        <!-- Column 1 -->
                                        <div class="col-12 md:col-6">
                                            <div class="field">
                                                <label for="name">{{ 'name-label' | transloco }}</label>
                                                <input pInputText id="name" formControlName="name"
                                                    [placeholder]="'namePlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="surname">{{ 'surname-label' | transloco }}</label>
                                                <input pInputText id="surname" formControlName="surname"
                                                    [placeholder]="'surnamePlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="birthday">{{ 'birthday-label' | transloco }}</label>
                                                <p-datePicker id="birthday" formControlName="birthday" [showIcon]="true"
                                                    dateFormat="dd/mm/yy" [readonlyInput]="true"></p-datePicker>
                                            </div>
                                            <div class="field">
                                                <label for="street">{{ 'street-label' | transloco }}</label>
                                                <input pInputText id="street" formControlName="street"
                                                    [placeholder]="'streetPlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="city">{{ 'city-label' | transloco }}</label>
                                                <input pInputText id="city" formControlName="city"
                                                    [placeholder]="'cityPlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="cap">{{ 'cap-label' | transloco }}</label>
                                                <input pInputText id="cap" formControlName="cap"
                                                    [placeholder]="'capPlaceholder' | transloco" />
                                                <small
                                                    *ngIf="clientForm.get('cap')?.invalid && clientForm.get('cap')?.touched"
                                                    class="p-error">
                                                    {{ 'cap-error' | transloco }}
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Column 2 -->
                                        <div class="col-12 md:col-6">
                                            <div class="field">
                                                <label for="province">{{ 'province-label' | transloco }}</label>
                                                <input pInputText id="province" formControlName="province"
                                                    [placeholder]="'provincePlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="number_city">{{ 'number-city-label' | transloco }}</label>
                                                <input pInputText id="number_city" formControlName="number_city"
                                                    [placeholder]="'numberCityPlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="telephone">{{ 'telephone-label' | transloco }}</label>
                                                <input pInputText id="telephone" formControlName="telephone"
                                                    [placeholder]="'telephonePlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="document_type">{{ 'document-type-label' | transloco
                                                    }}</label>
                                                <p-select id="document_type" formControlName="document_type"
                                                    [options]="documentTypes" optionLabel="label" optionValue="value"
                                                    [placeholder]="'documentTypePlaceholder' | transloco"
                                                    [filter]="true" filterBy="label"
                                                    filterPlaceholder="Search document types..." [showClear]="true"
                                                    class="w-16rem"></p-select>
                                            </div>
                                            <div class="field">
                                                <label for="document_number">{{ 'document-number-label' | transloco
                                                    }}</label>
                                                <input pInputText id="document_number" formControlName="document_number"
                                                    [placeholder]="'documentNumberPlaceholder' | transloco" />
                                            </div>
                                            <div class="field">
                                                <label for="cf">{{ 'cf-label' | transloco }}</label>
                                                <input pInputText id="cf" formControlName="cf"
                                                    [placeholder]="'cfPlaceholder' | transloco" />
                                                <small
                                                    *ngIf="clientForm.get('cf')?.invalid && clientForm.get('cf')?.touched"
                                                    class="p-error">
                                                    {{ 'cf-error' | transloco }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Portale Alloggi Required Fields -->
                                    <div class="card">
                                        <!--                                         <h3>{{ 'portale-alloggi-fields' | transloco }}</h3>
 -->
                                        <div class="grid">
                                            <div class="col-12 md:col-6">
                                                <div class="field">
                                                    <label for="sesso">{{ 'gender-label' | transloco }}</label>
                                                    <p-select id="sesso" formControlName="sesso"
                                                        [options]="genderOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'genderPlaceholder' | transloco" [filter]="true"
                                                        filterBy="label" class="w-16rem"></p-select>
                                                </div>
                                                <div class="field">
                                                    <label for="nazionalita">{{ 'nationality-label' | transloco
                                                        }}</label>
                                                    <p-select id="nazionalita" formControlName="nazionalita"
                                                        [options]="countryOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'nationalityPlaceholder' | transloco"
                                                        [filter]="true" filterBy="label"
                                                        filterPlaceholder="Search countries..." [showClear]="true"
                                                        class="w-16rem"></p-select>
                                                </div>
                                                <div class="field">
                                                    <label for="email">{{ 'email-label' | transloco }}</label>
                                                    <input pInputText id="email" formControlName="email" type="email"
                                                        [placeholder]="'emailPlaceholder' | transloco" />
                                                    <small
                                                        *ngIf="clientForm.get('email')?.invalid && clientForm.get('email')?.touched"
                                                        class="p-error">
                                                        {{ 'email-error' | transloco }}
                                                    </small>
                                                </div>
                                                <div class="field">
                                                    <label for="comune_nascita">{{ 'birth-municipality-label' |
                                                        transloco }}</label>
                                                    <input pInputText id="comune_nascita"
                                                        formControlName="comune_nascita"
                                                        [placeholder]="'birthMunicipalityPlaceholder' | transloco" />
                                                </div>
                                                <div class="field">
                                                    <label for="provincia_nascita">{{ 'birth-province-label' | transloco
                                                        }}</label>
                                                    <p-select id="provincia_nascita" formControlName="provincia_nascita"
                                                        [options]="provinceOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'birthProvincePlaceholder' | transloco"
                                                        [filter]="true" filterBy="label"
                                                        filterPlaceholder="Search provinces..." [showClear]="true"
                                                        class="w-16rem"></p-select>
                                                </div>
                                                <div class="field">
                                                    <label for="stato_nascita">{{ 'birth-country-label' | transloco
                                                        }}</label>
                                                    <p-select id="stato_nascita" formControlName="stato_nascita"
                                                        [options]="countryOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'birthCountryPlaceholder' | transloco"
                                                        [filter]="true" filterBy="label"
                                                        filterPlaceholder="Search countries..." [showClear]="true"
                                                        class="w-16rem"></p-select>
                                                </div>
                                                <div class="field">
                                                    <label for="cittadinanza">{{ 'citizenship-label' | transloco
                                                        }}</label>
                                                    <p-select id="cittadinanza" formControlName="cittadinanza"
                                                        [options]="countryOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'citizenshipPlaceholder' | transloco"
                                                        [filter]="true" filterBy="label"
                                                        filterPlaceholder="Search countries..." [showClear]="true"
                                                        class="w-16rem"></p-select>
                                                </div>
                                            </div>
                                            <div class="col-12 md:col-6">
                                                <div class="field">
                                                    <label for="luogo_emissione">{{ 'document-issue-place-label' |
                                                        transloco }}</label>
                                                    <input pInputText id="luogo_emissione"
                                                        formControlName="luogo_emissione"
                                                        [placeholder]="'documentIssuePlacePlaceholder' | transloco" />
                                                </div>
                                                <div class="field">
                                                    <label for="data_emissione">{{ 'document-issue-date-label' |
                                                        transloco }}</label>
                                                    <p-datePicker id="data_emissione" formControlName="data_emissione"
                                                        dateFormat="yy-mm-dd" [showIcon]="true" [readonlyInput]="true"
                                                        (onSelect)="onDateChange()" class="w-16rem"></p-datePicker>
                                                </div>
                                                <div class="field">
                                                    <label for="data_scadenza">{{ 'document-expiry-date-label' |
                                                        transloco }}</label>
                                                    <p-datePicker id="data_scadenza" formControlName="data_scadenza"
                                                        dateFormat="yy-mm-dd" [showIcon]="true" [readonlyInput]="true"
                                                        (onSelect)="onDateChange()" class="w-16rem"></p-datePicker>
                                                    <small
                                                        *ngIf="clientForm.hasError('documentDateInvalid') && 
                                                        (clientForm.get('data_emissione')?.touched || clientForm.get('data_scadenza')?.touched)"
                                                        class="p-error">
                                                        {{ 'document-expiry-date-error' | transloco }}
                                                    </small>
                                                </div>
                                                <div class="field">
                                                    <label for="autorita_rilascio">{{ 'issuing-authority-label' |
                                                        transloco }}</label>
                                                    <input pInputText id="autorita_rilascio"
                                                        formControlName="autorita_rilascio"
                                                        [placeholder]="'issuingAuthorityPlaceholder' | transloco" />
                                                </div>
                                                <div class="field">
                                                    <label for="comune_residenza">{{ 'residence-municipality-label' |
                                                        transloco }}</label>
                                                    <input pInputText id="comune_residenza"
                                                        formControlName="comune_residenza"
                                                        [placeholder]="'residenceMunicipalityPlaceholder' | transloco" />
                                                </div>
                                                <div class="field">
                                                    <label for="provincia_residenza">{{ 'residence-province-label' |
                                                        transloco }}</label>
                                                    <p-select id="provincia_residenza"
                                                        formControlName="provincia_residenza"
                                                        [options]="provinceOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'residenceProvincePlaceholder' | transloco"
                                                        [filter]="true" filterBy="label"
                                                        filterPlaceholder="Search provinces..." [showClear]="true"
                                                        class="w-16rem"></p-select>
                                                </div>
                                                <div class="field">
                                                    <label for="stato_residenza">{{ 'residence-country-label' |
                                                        transloco }}</label>
                                                    <p-select id="stato_residenza" formControlName="stato_residenza"
                                                        [options]="countryOptions" optionLabel="label"
                                                        optionValue="value"
                                                        [placeholder]="'residenceCountryPlaceholder' | transloco"
                                                        [filter]="true" filterBy="label"
                                                        filterPlaceholder="Search countries..." [showClear]="true"
                                                        class="w-16rem"></p-select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex justify-content-end">
                                        <!--                    <p-button type="submit" label="Submit" [disabled]="clientForm.invalid"
                                            icon="pi pi-check"></p-button> -->
                                    </div>
                                </form>
                            </p-card>
                        </div>

                    </div>
                    <div class="flex  pt-6 justify-content-end">
                        <p-button [label]="'next' | transloco" icon="pi pi-arrow-right" iconPos="right"
                            [disabled]="clientForm.invalid || !canRegister" (onClick)="activateCallback(2)" />
                    </div>
                </ng-template>
            </p-step-panel>

            <p-step-panel [value]="2">
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="flex flex-col h-48" [class.opacity-50]="!canRegister">
                        <div class="flex-auto justify-center items-center font-medium">
                            <app-upload-identity (formDataEmitter)="handleFormData($event)"></app-upload-identity>
                        </div>
                    </div>
                    <div class="flex justify-space-between w-full pt-6">
                        <p-button [label]="'back' | transloco" severity="secondary" icon="pi pi-arrow-left"
                            (onClick)="activateCallback(1)" />

                        <p-button [label]="'next' | transloco" icon="pi pi-arrow-right" iconPos="right"
                            [disabled]="uploadForm.invalid || !canRegister" (onClick)="activateCallback(3)" />
                    </div>
                </ng-template>
            </p-step-panel>

            <p-step-panel [value]="3">
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="grid">
                        <!-- Form Recap Section -->
                        <div class="col-6">
                            <p-card header="{{ 'form-details' | transloco }}">
                                <div class="form-recap p-3">
                                    <p><strong>{{ 'reservation-id-label' | transloco }}</strong> {{ reservationId }}</p>
                                    <p><strong>{{ 'name-label' | transloco }}</strong> {{ clientForm.get('name')?.value
                                        }}</p>
                                    <p><strong>{{ 'surname-label' | transloco }}</strong> {{
                                        clientForm.get('surname')?.value }}</p>
                                    <p><strong>{{ 'birthday-label' | transloco }}</strong> {{
                                        clientForm.get('birthday')?.value | date }}</p>
                                    <p><strong>{{ 'street-label' | transloco }}</strong> {{
                                        clientForm.get('street')?.value }}</p>
                                    <p><strong>{{ 'city-label' | transloco }}</strong> {{ clientForm.get('city')?.value
                                        }}</p>
                                    <p><strong>{{ 'province-label' | transloco }}</strong> {{
                                        clientForm.get('province')?.value }}</p>
                                    <p><strong>{{ 'cap-label' | transloco }}</strong> {{ clientForm.get('cap')?.value }}
                                    </p>
                                    <p><strong>{{ 'telephone-label' | transloco }}</strong> {{
                                        clientForm.get('telephone')?.value }}</p>
                                    <p><strong>{{ 'document-type-label' | transloco }}</strong>
                                        {{ (clientForm.get('document_type')?.value | documentTypeLabel) | transloco }}
                                    </p>
                                    <p><strong>{{ 'document-number-label' | transloco }}</strong> {{
                                        clientForm.get('document_number')?.value }}</p>
                                    <p><strong>{{ 'cf-label' | transloco }}</strong> {{ clientForm.get('cf')?.value }}
                                    </p>

                                    <!-- Portale Alloggi Fields -->
                                    <hr class="my-3">
                                    <h4 class="mb-2">{{ 'portale-alloggi-fields' | transloco }}</h4>
                                    <p><strong>{{ 'gender-label' | transloco }}</strong> {{
                                        (clientForm.get('sesso')?.value === '1' ? 'male' : 'female') | transloco }}</p>
                                    <p><strong>{{ 'nationality-label' | transloco }}</strong> {{
                                        clientForm.get('nazionalita')?.value }}</p>
                                    <p><strong>{{ 'email-label' | transloco }}</strong> {{
                                        clientForm.get('email')?.value }}</p>
                                    <p><strong>{{ 'birth-municipality-label' | transloco }}</strong> {{
                                        clientForm.get('comune_nascita')?.value }}</p>
                                    <p><strong>{{ 'birth-province-label' | transloco }}</strong> {{
                                        clientForm.get('provincia_nascita')?.value }}</p>
                                    <p><strong>{{ 'birth-country-label' | transloco }}</strong> {{
                                        clientForm.get('stato_nascita')?.value }}</p>
                                    <p><strong>{{ 'citizenship-label' | transloco }}</strong> {{
                                        clientForm.get('cittadinanza')?.value }}</p>
                                    <p><strong>{{ 'document-issue-place-label' | transloco }}</strong> {{
                                        clientForm.get('luogo_emissione')?.value }}</p>
                                    <p><strong>{{ 'document-issue-date-label' | transloco }}</strong> {{
                                        clientForm.get('data_emissione')?.value | date }}</p>
                                    <p><strong>{{ 'document-expiry-date-label' | transloco }}</strong> {{
                                        clientForm.get('data_scadenza')?.value | date }}</p>
                                    <p><strong>{{ 'issuing-authority-label' | transloco }}</strong> {{
                                        clientForm.get('autorita_rilascio')?.value }}</p>
                                    <p><strong>{{ 'residence-municipality-label' | transloco }}</strong> {{
                                        clientForm.get('comune_residenza')?.value }}</p>
                                    <p><strong>{{ 'residence-province-label' | transloco }}</strong> {{
                                        clientForm.get('provincia_residenza')?.value }}</p>
                                    <p><strong>{{ 'residence-country-label' | transloco }}</strong> {{
                                        clientForm.get('stato_residenza')?.value }}</p>
                                </div>
                            </p-card>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="col-6">
                            <p-card header="{{ 'uploaded-images' | transloco }}">
                                <div class="image-upload-section p-3 flex flex-col items-center">
                                    <div *ngIf="uploadForm.get('frontimage')?.value['objectURL']" class="pt-3 pr-3">
                                        <p><strong>{{ 'front-image-label' | transloco }}</strong></p>
                                        <img [src]="uploadForm.get('frontimage')?.value['objectURL']"
                                            [alt]="'front-image-label' | transloco"
                                            class="image-preview w-32 h-32 object-cover rounded-md shadow-md border border-gray-300" />
                                    </div>

                                    <div *ngIf="uploadForm?.get('backimage')?.value['objectURL']" class="pt-3 pr-3">
                                        <p><strong>{{ 'back-image-label' | transloco }}</strong></p>
                                        <img [src]="uploadForm.get('backimage')?.value['objectURL']"
                                            [alt]="'back-image-label' | transloco"
                                            class="image-preview w-32 h-32 object-cover rounded-md shadow-md border border-gray-300" />
                                    </div>

                                    <div *ngIf="uploadForm?.get('selfie')?.value['objectURL']" class="pt-3">
                                        <p><strong>{{ 'selfie-image-label' | transloco }}</strong></p>
                                        <img [src]="uploadForm.get('selfie')?.value['objectURL']"
                                            [alt]="'selfie-image-label' | transloco"
                                            class="image-preview w-32 h-32 object-cover rounded-md shadow-md border border-gray-300" />
                                    </div>
                                </div>
                            </p-card>
                        </div>
                    </div>

                    <!-- Submit Button Section - Centered -->
                    <div class="flex justify-center pt-4 w-full">
                        <p-button [label]="'submit' | transloco" icon="pi pi-check" class="p-button-lg"
                            [disabled]="clientForm.invalid || uploadForm.invalid || !canRegister"
                            (onClick)="uploadReservationData()"></p-button>
                    </div>

                    <div class="flex pt-6 justify-start">
                        <p-button [label]="'back' | transloco" icon="pi pi-arrow-left" iconPos="right"
                            (onClick)="activateCallback(2)" />
                    </div>
                </ng-template>
            </p-step-panel>
        </p-step-panels>
    </p-stepper>
</div>

<p-dialog [(visible)]="showConfirmationDialog" modal [header]="'confirmation-sent-title' | transloco"
    [style]="{ width: '400px' }">
    <p>{{ 'confirmation-sent-message' | transloco }}</p>
    <ng-template pTemplate="footer">
        <button pButton [label]="'ok' | transloco" icon="pi pi-check" (click)="closeDialog()"></button>
    </ng-template>
</p-dialog>